<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- PWA Meta Tags -->
  <meta name="application-name" content="H√§kelrechner">
  <meta name="apple-mobile-web-app-title" content="H√§kelrechner">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#3b82f6">
  <meta name="theme-color" content="#3b82f6">
  
  <!-- App Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
  <link rel="apple-touch-icon" href="icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
  
  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <title>üß∂ Profi-H√§kelrechner PWA</title>
  <style>
    /* Basis-Styling */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #fdf2f8 0%, #f3e8ff 100%);
      min-height: 100vh;
      padding: 10px;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 25px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    h1 {
      color: #1f2937;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.5em;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      color: #6b7280;
      margin-bottom: 30px;
      font-size: 1.1em;
      font-weight: 500;
    }

    /* Pattern Tabs */
    .pattern-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 25px;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #e5e7eb;
    }

    .tab {
      flex: 1;
      min-width: 130px;
      padding: 14px 10px;
      background: #f9fafb;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
      color: #374151;
    }

    .tab.active {
      background: #3b82f6;
      color: white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .tab:hover:not(.active) {
      background: #e5e7eb;
      transform: translateY(-1px);
    }

    /* Input Groups */
    .input-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
    }

    .input-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
      font-size: 0.95em;
    }

    .input-group input,
    .input-group select {
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }

    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Calculation Result */
    .calculation-result {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .calculation-result h3 {
      color: #1e40af;
      margin-bottom: 10px;
      font-size: 1.2em;
    }

    .calculation-result p {
      color: #1e40af;
      font-weight: 500;
      font-size: 1.1em;
    }

    /* Diagram Container */
    .diagram-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    .diagram-canvas {
      max-width: 100%;
      height: 400px;
      border: 2px solid #d1d5db;
      border-radius: 10px;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Symbol Reference */
    .symbol-reference {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .symbol-category {
      background: #f8fafc;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }

    .symbol-category h4 {
      color: #374151;
      margin-bottom: 15px;
      font-size: 1.1em;
      font-weight: 600;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 8px;
    }

    .symbol-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      padding: 8px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }

    .symbol-visual {
      width: 30px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
      border: 2px solid #374151;
      background: white;
      border-radius: 4px;
      flex-shrink: 0;
      color: #374151;
    }

    .symbol-item span {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }

    /* Instructions */
    .instructions {
      background: #f8fafc;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .instructions h3 {
      color: #1f2937;
      margin-bottom: 20px;
      font-size: 1.3em;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 10px;
    }

    .round-instruction {
      background: white;
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .round-number {
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 8px;
      font-size: 1.1em;
    }

    .stitch-count {
      color: #059669;
      font-weight: 600;
      font-size: 0.9em;
    }

    .round-text {
      color: #4b5563;
      line-height: 1.5;
    }

    /* Materials Section */
    .materials-section {
      background: #f0f9ff;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .materials-section h3 {
      color: #1e40af;
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    .materials-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
    }

    .material-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #bfdbfe;
      text-align: center;
    }

    .material-item h4 {
      color: #1e40af;
      margin-bottom: 8px;
      font-size: 1em;
    }

    .material-item p {
      color: #374151;
      font-weight: 500;
      font-size: 0.95em;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 5px;
      }

      .card {
        padding: 20px;
        margin-bottom: 15px;
      }

      h1 {
        font-size: 2em;
      }

      .input-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .diagram-canvas {
        height: 300px;
      }

      .symbol-reference {
        grid-template-columns: 1fr;
      }

      .tab {
        min-width: 100px;
        padding: 12px 8px;
        font-size: 12px;
      }

      .materials-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .pwa-features {
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid #a5b4fc;
    }
    
    .pwa-features h3 {
      color: #3730a3;
      margin-bottom: 15px;
      font-size: 1.2em;
    }
    
    .pwa-features ul {
      list-style: none;
      padding: 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
    }
    
    .pwa-features li {
      padding: 5px 0;
      color: #3730a3;
      font-weight: 500;
    }
    
    .pwa-features li::before {
      content: "‚úì ";
      color: #10b981;
      font-weight: bold;
    }
    
    .project-management {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border: 1px solid #e5e7eb;
    }
    
    .project-management h3 {
      color: #374151;
      margin-bottom: 15px;
      font-size: 1.2em;
    }
    
    .project-input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }
    
    .project-input-row input {
      flex: 1;
      padding: 10px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .save-project-btn {
      background: #059669;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .save-project-btn:hover {
      background: #047857;
      transform: translateY(-1px);
    }
    
    .share-project-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 12px;
      margin-left: 10px;
    }
    
    .share-project-btn:hover {
      background: #2563eb;
    }
    
    .projects-list {
      background: white;
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
    }
    
    .project-item {
      padding: 15px;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .project-item:hover {
      background: #f0f9ff;
    }
    
    .project-item:last-child {
      border-bottom: none;
    }
    
    .project-name {
      font-weight: 600;
      color: #374151;
      margin-bottom: 5px;
    }
    
    .project-details {
      font-size: 12px;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .project-actions {
      display: flex;
      gap: 5px;
    }
    
    .project-actions button {
      background: none;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    
    .project-actions .edit-btn {
      color: #3b82f6;
    }
    
    .project-actions .edit-btn:hover {
      background: #eff6ff;
    }
    
    .project-actions .delete-btn {
      color: #ef4444;
    }
    
    .project-actions .delete-btn:hover {
      background: #fef2f2;
    }
    
    .project-actions .share-btn {
      color: #059669;
    }
    
    .project-actions .share-btn:hover {
      background: #f0fdf4;
    }
    
    .empty-projects {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }
    
    .empty-projects-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    .install-banner {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      justify-content: space-between;
    }
    
    .install-banner.show {
      display: flex;
    }
    
    .install-banner-text {
      flex: 1;
      margin-right: 15px;
    }
    
    .install-banner-text h4 {
      margin: 0 0 5px 0;
      font-size: 1.1em;
    }
    
    .install-banner-text p {
      margin: 0;
      font-size: 0.9em;
      opacity: 0.9;
    }
    
    .install-banner-buttons {
      display: flex;
      gap: 10px;
    }
    
    .install-banner-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .install-now-btn {
      background: white;
      color: #3b82f6;
    }
    
    .install-now-btn:hover {
      background: #f8fafc;
    }
    
    .install-later-btn {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    
    .install-later-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    @media (max-width: 480px) {
      .materials-grid {
        grid-template-columns: 1fr;
      }
      
      .project-input-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .project-input-row input {
        margin-bottom: 10px;
      }
      
      .pwa-features ul {
        grid-template-columns: 1fr;
      }
      
      .install-banner {
        flex-direction: column;
        text-align: center;
      }
      
      .install-banner-text {
        margin-right: 0;
        margin-bottom: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- PWA Install Banner -->
    <div class="install-banner" id="installBanner">
      <div class="install-banner-text">
        <h4>üì± Als App installieren</h4>
        <p>Nutze den H√§kelrechner offline und mit nativer App-Erfahrung</p>
      </div>
      <div class="install-banner-buttons">
        <button class="install-now-btn" onclick="installPWA()">Installieren</button>
        <button class="install-later-btn" onclick="hideInstallBanner()">Sp√§ter</button>
      </div>
    </div>
    
    <!-- Header -->
    <div class="card">
      <h1>üß∂ Profi-H√§kelrechner</h1>
      <p class="subtitle">Vollst√§ndige Symbolbibliothek ‚Ä¢ Professionelle Diagramme ‚Ä¢ Pr√§zise Berechnungen</p>
      
      <!-- PWA Features -->
      <div class="pwa-features">
        <h3>üöÄ PWA Features</h3>
        <ul>
          <li>Offline-Funktionalit√§t</li>
          <li>Installierbar als App</li>
          <li>Projekte lokal speichern</li>
          <li>Push-Benachrichtigungen</li>
          <li>Schnelle Performance</li>
          <li>Automatische Updates</li>
        </ul>
      </div>
      
      <!-- Projekt-Management -->
      <div class="project-management">
        <h3>üìÇ Projekt-Verwaltung</h3>
        <div class="project-input-row">
          <input type="text" id="projectName" placeholder="Projekt-Name eingeben..." maxlength="50">
          <button class="save-project-btn" onclick="saveCurrentProject()">
            üíæ Speichern
          </button>
        </div>
        
        <div class="projects-list" id="projectsList">
          <div class="empty-projects">
            <div class="empty-projects-icon">üìÅ</div>
            <p>Noch keine Projekte gespeichert</p>
          </div>
        </div>
      </div>
      
      <!-- Muster-Tabs -->
      <div class="pattern-tabs">
        <button class="tab active" data-pattern="granny-classic">Klassisches Granny</button>
        <button class="tab" data-pattern="granny-solid">Solid Granny</button>
        <button class="tab" data-pattern="circle-basic">Einfacher Kreis</button>
        <button class="tab" data-pattern="shell-pattern">Shell-Muster</button>
        <button class="tab" data-pattern="cluster-pattern">Cluster-Muster</button>
        <button class="tab" data-pattern="popcorn-pattern">Popcorn-Muster</button>
      </div>
      
      <!-- Eingabefelder -->
      <div class="input-row">
        <div class="input-group">
          <label for="rounds">Anzahl Runden:</label>
          <input type="number" id="rounds" value="4" min="1" max="15">
        </div>
        <div class="input-group">
          <label for="startStitches">Startmaschen:</label>
          <input type="number" id="startStitches" value="6" min="3" max="24">
        </div>
        <div class="input-group">
          <label for="stitchType">Hauptstich:</label>
          <select id="stitchType">
            <option value="sc">feste Maschen (fM)</option>
            <option value="hdc">halbe St√§bchen (hStb)</option>
            <option value="dc" selected>ganze St√§bchen (Stb)</option>
            <option value="tr">doppelte St√§bchen (dStb)</option>
          </select>
        </div>
        <div class="input-group">
          <label for="yarnWeight">Garnst√§rke:</label>
          <select id="yarnWeight">
            <option value="lace">Lace (0)</option>
            <option value="sport">Sport (2)</option>
            <option value="dk">DK (3)</option>
            <option value="worsted" selected>Worsted (4)</option>
            <option value="bulky">Bulky (5)</option>
          </select>
        </div>
      </div>
      
      <!-- Berechnungsergebnis -->
      <div class="calculation-result" id="calculationResult">
        <h3>üí° Aktuelle Berechnung:</h3>
        <p id="resultText">Berechnungen werden geladen...</p>
      </div>
    </div>
    
    <!-- Diagramm -->
    <div class="card">
      <h2>üìä H√§keldiagramm</h2>
      <div class="diagram-container">
        <canvas id="diagramCanvas" class="diagram-canvas" width="400" height="400"></canvas>
      </div>
    </div>
    
    <!-- Symbolreferenz -->
    <div class="card">
      <h2>üìö H√§kelsymbol-Referenz</h2>
      <div class="symbol-reference">
        <div class="symbol-category">
          <h4>Grundstiche</h4>
          <div class="symbol-item">
            <div class="symbol-visual">o</div>
            <span>Luftmasche (Lm)</span>
          </div>
          <div class="symbol-item">
            <div class="symbol-visual">‚Ä¢</div>
            <span>Kettmasche (Km)</span>
          </div>
          <div class="symbol-item">
            <div class="symbol-visual">+</div>
            <span>feste Masche (fM)</span>
          </div>
          <div class="symbol-item">
            <div class="symbol-visual">T</div>
            <span>halbes St√§bchen (hStb)</span>
          </div>
          <div class="symbol-item">
            <div class="symbol-visual">|</div>
            <span>ganzes St√§bchen (Stb)</span>
          </div>
          <div class="symbol-item">
            <div class="symbol-visual">||</div>
            <span>doppeltes St√§bchen (dStb)</span>
          </div>
        </div>
        
        <div class="symbol-category">
          <h4>Cluster & Gruppen</h4>
          <div class="symbol-item">
            <div class="symbol-visual">C3</div>
            <span>3-Stb-Cluster</span>
          </div>
          <div class="symbol-item">
            <div class="symbol-visual">C5</div>
            <span>5-Stb-Cluster</span>
          </div>
          <div class="symbol-item">
            <div class="symbol-visual">SH</div>
            <span>Shell (Muschel)</span>
          </div>
          <div class="symbol-item">
            <div class="symbol-visual">V</div>
            <span>V-Stitch</span>
          </div>
        </div>
        
        <div class="symbol-category">
          <h4>Popcorn & Bobbles</h4>
          <div class="symbol-item">
            <div class="symbol-visual">P3</div>
            <span>3-Stb-Popcorn</span>
          </div>
          <div class="symbol-item">
            <div class="symbol-visual">P5</div>
            <span>5-Stb-Popcorn</span>
          </div>
          <div class="symbol-item">
            <div class="symbol-visual">B</div>
            <span>Bobble</span>
          </div>
        </div>
        
        <div class="symbol-category">
          <h4>Zu-/Abnahmen</h4>
          <div class="symbol-item">
            <div class="symbol-visual">/\</div>
            <span>2 Stb zusammen</span>
          </div>
          <div class="symbol-item">
            <div class="symbol-visual">\/</div>
            <span>2 Stb in 1 Masche</span>
          </div>
          <div class="symbol-item">
            <div class="symbol-visual">/^\</div>
            <span>3 Stb zusammen</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Anleitung -->
    <div class="card">
      <h2>üìù H√§kelanleitung</h2>
      <div class="instructions" id="instructionsContainer">
        <h3>üß∂ Anleitung wird generiert...</h3>
      </div>
      
      <!-- Materialien -->
      <div class="materials-section">
        <h3>üß∂ Materialien & Verbrauch</h3>
        <div class="materials-grid">
          <div class="material-item">
            <h4>Garn</h4>
            <p id="yarnAmount">Wird berechnet...</p>
          </div>
          <div class="material-item">
            <h4>H√§kelnadel</h4>
            <p id="hookSize">Wird berechnet...</p>
          </div>
          <div class="material-item">
            <h4>Fertige Gr√∂√üe</h4>
            <p id="finishedSize">Wird berechnet...</p>
          </div>
          <div class="material-item">
            <h4>Arbeitszeit</h4>
            <p id="workTime">Wird berechnet...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Scripts -->
  <script src="js/db.js"></script>
  <script src="js/pwa.js"></script>
  
  <script>
    // Globale Variablen
    let currentPattern = 'granny-classic';
    let currentRounds = 4;
    let startStitches = 6;

    // Garnst√§rke-Spezifikationen
    const yarnWeights = {
      'lace': { 
        hookSize: '2.0-3.5mm', 
        gauge: '32-42 M', 
        yarnFactor: 0.8,
        description: 'Lace (0) - Sehr fein'
      },
      'sport': { 
        hookSize: '3.5-4.5mm', 
        gauge: '21-24 M', 
        yarnFactor: 1.0,
        description: 'Sport (2) - Fein'
      },
      'dk': { 
        hookSize: '4.5-5.5mm', 
        gauge: '16-20 M', 
        yarnFactor: 1.2,
        description: 'DK (3) - Leicht'
      },
      'worsted': { 
        hookSize: '5.5-6.5mm', 
        gauge: '11-14 M', 
        yarnFactor: 1.4,
        description: 'Worsted (4) - Medium'
      },
      'bulky': { 
        hookSize: '6.5-9.0mm', 
        gauge: '8-11 M', 
        yarnFactor: 1.8,
        description: 'Bulky (5) - Dick'
      }
    };

    // H√§kelsymbol-Bibliothek
    const stitchSymbols = {
      'chain': { symbol: 'o', display: 'Luftmasche (Lm)', draw: 'circle' },
      'slip': { symbol: '‚Ä¢', display: 'Kettmasche (Km)', draw: 'filled-circle' },
      'sc': { symbol: '+', display: 'feste Masche (fM)', draw: 'cross' },
      'hdc': { symbol: 'T', display: 'halbes St√§bchen (hStb)', draw: 'T-shape' },
      'dc': { symbol: '|', display: 'ganzes St√§bchen (Stb)', draw: 'line-with-bar' },
      'tr': { symbol: '||', display: 'doppeltes St√§bchen (dStb)', draw: 'line-with-two-bars' },
      'dtr': { symbol: '|||', display: 'dreifaches St√§bchen (drStb)', draw: 'line-with-three-bars' },
      'cluster3': { symbol: 'C3', display: '3-Stb-Cluster', draw: 'cluster-3' },
      'cluster5': { symbol: 'C5', display: '5-Stb-Cluster', draw: 'cluster-5' },
      'shell': { symbol: 'SH', display: 'Shell (Muschel)', draw: 'shell-shape' },
      'vstitch': { symbol: 'V', display: 'V-Stitch', draw: 'v-shape' },
      'popcorn3': { symbol: 'P3', display: '3-Stb-Popcorn', draw: 'popcorn-3' },
      'popcorn5': { symbol: 'P5', display: '5-Stb-Popcorn', draw: 'popcorn-5' },
      'bobble': { symbol: 'B', display: 'Bobble', draw: 'bobble-shape' },
      'dec2': { symbol: '/\\', display: '2 Stb zusammen', draw: 'decrease-2' },
      'inc2': { symbol: '\\/', display: '2 Stb in 1 Masche', draw: 'increase-2' },
      'dec3': { symbol: '/^\\', display: '3 Stb zusammen', draw: 'decrease-3' }
    };

    // H√§kelmuster-Definitionen
    const patterns = {
      'granny-classic': {
        name: 'Klassisches Granny Square',
        center: 'magic-ring',
        mainStitch: 'dc',
        type: 'square',
        rounds: [
          {
            round: 1,
            description: 'Magischer Ring, 3 Lm (= 1. Stb), 2 Stb, 2 Lm, *3 Stb, 2 Lm* 3x wiederholen. Mit Km schlie√üen.',
            stitches: 12,
            increases: 0,
            type: 'treble-groups',
            symbols: ['chain', 'dc', 'dc', 'dc', 'chain', 'chain']
          },
          {
            round: 2,
            description: '3 Lm, 2 Stb, 2 Lm, 3 Stb in Eckbogen, *1 Lm, in n√§chste Ecke: 3 Stb, 2 Lm, 3 Stb* 3x. Mit Km schlie√üen.',
            stitches: 24,
            increases: 12,
            type: 'treble-groups',
            symbols: ['chain', 'dc', 'dc', 'dc', 'chain', 'chain', 'dc', 'dc', 'dc']
          }
        ]
      },
      'granny-solid': {
        name: 'Solid Granny Square',
        center: 'magic-ring',
        mainStitch: 'dc',
        type: 'square',
        rounds: [
          {
            round: 1,
            description: 'Magischer Ring, 3 Lm (= 1. Stb), 11 Stb. Mit Km schlie√üen.',
            stitches: 12,
            increases: 0,
            type: 'treble-solid'
          }
        ]
      },
      'circle-basic': {
        name: 'Einfacher Kreis',
        center: 'magic-ring',
        mainStitch: 'sc',
        type: 'circle',
        formula: 'startStitches * round',
        rounds: [
          {
            round: 1,
            description: 'Magischer Ring, 6 feste Maschen. Mit Km schlie√üen.',
            stitches: 6,
            increases: 0,
            type: 'single-crochet'
          }
        ]
      },
      'shell-pattern': {
        name: 'Shell-Muster',
        center: 'magic-ring',
        mainStitch: 'dc',
        type: 'circle',
        rounds: [
          {
            round: 1,
            description: 'Magischer Ring, 3 Lm, 4 Stb, 2 Lm, *5 Stb, 2 Lm* 5x wiederholen. Mit Km schlie√üen.',
            stitches: 30,
            increases: 0,
            type: 'shell-groups'
          }
        ]
      },
      'cluster-pattern': {
        name: 'Cluster-Muster',
        center: 'magic-ring',
        mainStitch: 'dc',
        type: 'circle',
        rounds: [
          {
            round: 1,
            description: 'Magischer Ring, 3 Lm, 3-Stb-Cluster, 3 Lm, *3-Stb-Cluster, 3 Lm* 7x wiederholen. Mit Km schlie√üen.',
            stitches: 24,
            increases: 0,
            type: 'cluster-groups'
          }
        ]
      },
      'popcorn-pattern': {
        name: 'Popcorn-Muster',
        center: 'magic-ring',
        mainStitch: 'dc',
        type: 'circle',
        rounds: [
          {
            round: 1,
            description: 'Magischer Ring, 3 Lm, 5-Stb-Popcorn, 2 Lm, *5-Stb-Popcorn, 2 Lm* 5x wiederholen. Mit Km schlie√üen.',
            stitches: 18,
            increases: 0,
            type: 'popcorn-groups'
          }
        ]
      }
    };

    // Canvas-Zeichenfunktionen
    function drawSymbol(ctx, symbol, x, y, size = 1, color = '#374151') {
      ctx.strokeStyle = color;
      ctx.fillStyle = color;
      ctx.lineWidth = 2 * size;
      ctx.font = `${14 * size}px Arial`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      switch(symbol) {
        case 'chain':
          ctx.beginPath();
          ctx.arc(x, y, 4 * size, 0, 2 * Math.PI);
          ctx.stroke();
          break;
          
        case 'slip':
          ctx.beginPath();
          ctx.arc(x, y, 3 * size, 0, 2 * Math.PI);
          ctx.fill();
          break;
          
        case 'sc':
          ctx.beginPath();
          ctx.moveTo(x - 5 * size, y);
          ctx.lineTo(x + 5 * size, y);
          ctx.moveTo(x, y - 5 * size);
          ctx.lineTo(x, y + 5 * size);
          ctx.stroke();
          break;
          
        case 'hdc':
          ctx.beginPath();
          ctx.moveTo(x, y - 8 * size);
          ctx.lineTo(x, y + 8 * size);
          ctx.moveTo(x - 4 * size, y - 2 * size);
          ctx.lineTo(x + 4 * size, y - 2 * size);
          ctx.stroke();
          break;
          
        case 'dc':
          ctx.beginPath();
          ctx.moveTo(x, y - 10 * size);
          ctx.lineTo(x, y + 10 * size);
          ctx.moveTo(x - 4 * size, y);
          ctx.lineTo(x + 4 * size, y);
          ctx.stroke();
          break;
          
        case 'tr':
          ctx.beginPath();
          ctx.moveTo(x, y - 12 * size);
          ctx.lineTo(x, y + 12 * size);
          ctx.moveTo(x - 4 * size, y - 3 * size);
          ctx.lineTo(x + 4 * size, y - 3 * size);
          ctx.moveTo(x - 4 * size, y + 3 * size);
          ctx.lineTo(x + 4 * size, y + 3 * size);
          ctx.stroke();
          break;
          
        case 'cluster3':
          ctx.fillText('C3', x, y);
          break;
        case 'cluster5':
          ctx.fillText('C5', x, y);
          break;
        case 'shell':
          ctx.fillText('SH', x, y);
          break;
        case 'popcorn3':
          ctx.fillText('P3', x, y);
          break;
        case 'popcorn5':
          ctx.fillText('P5', x, y);
          break;
        case 'inc2':
          ctx.fillText('\\/', x, y);
          break;
        case 'dec2':
          ctx.fillText('/\\', x, y);
          break;
          
        default:
          ctx.fillText(symbol, x, y);
      }
    }

    // Berechnungsfunktionen
    function calculateStitches(pattern, rounds, startStitches) {
      const results = [];
      
      for (let round = 1; round <= rounds; round++) {
        let stitches, increases;
        
        if (pattern.name === 'Einfacher Kreis') {
          stitches = startStitches * round;
          increases = round === 1 ? 0 : startStitches;
        } else if (pattern.name === 'Klassisches Granny Square') {
          stitches = 12 + (round - 1) * 12;
          increases = round === 1 ? 0 : 12;
        } else if (pattern.name === 'Solid Granny Square') {
          stitches = 12 * round;
          increases = round === 1 ? 0 : 12;
        } else if (pattern.name === 'Shell-Muster') {
          stitches = 30 + (round - 1) * 30;
          increases = round === 1 ? 0 : 30;
        } else if (pattern.name === 'Cluster-Muster') {
          stitches = 24 + (round - 1) * 24;
          increases = round === 1 ? 0 : 24;
        } else if (pattern.name === 'Popcorn-Muster') {
          stitches = 18 + (round - 1) * 18;
          increases = round === 1 ? 0 : 18;
        }
        
        results.push({
          round,
          stitches,
          increases,
          description: getPatternDescription(pattern, round, stitches)
        });
      }
      
      return results;
    }

    function getPatternDescription(pattern, round, stitches) {
      const baseDescription = pattern.rounds[round - 1]?.description;
      if (baseDescription) return baseDescription;
      
      switch (pattern.name) {
        case 'Einfacher Kreis':
          return `Runde ${round}: In jede ${round}. Masche 2 fM h√§keln, in die anderen je 1 fM. (${stitches} Maschen)`;
        case 'Klassisches Granny Square':
          return `Runde ${round}: In jede Ecke 3 Stb, 2 Lm, 3 Stb. Zwischen den Ecken je 3 Stb. (${stitches} Maschen)`;
        case 'Solid Granny Square':
          return `Runde ${round}: Gleichm√§√üig verteilt ${stitches} Stb h√§keln.`;
        case 'Shell-Muster':
          return `Runde ${round}: In jeden Bogen 5 Stb (Shell) h√§keln. (${stitches} Maschen)`;
        case 'Cluster-Muster':
          return `Runde ${round}: Abwechselnd 3-Stb-Cluster und 3 Lm h√§keln. (${stitches} Maschen)`;
        case 'Popcorn-Muster':
          return `Runde ${round}: In jeden Bogen 5-Stb-Popcorn h√§keln. (${stitches} Maschen)`;
        default:
          return `Runde ${round}: Nach Muster weiter h√§keln. (${stitches} Maschen)`;
      }
    }

    // Diagramm-Zeichenfunktionen
    function drawDiagram() {
      const canvas = document.getElementById('diagramCanvas');
      const ctx = canvas.getContext('2d');
      
      // High-DPI Setup
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      
      ctx.clearRect(0, 0, rect.width, rect.height);
      
      // Muster-spezifische Zeichnung
      if (currentPattern === 'granny-classic' || currentPattern === 'granny-solid') {
        drawGrannySquareDiagram(ctx, centerX, centerY, currentRounds);
      } else if (currentPattern === 'circle-basic') {
        drawCircleDiagram(ctx, centerX, centerY, currentRounds, startStitches);
      } else if (currentPattern === 'shell-pattern') {
        drawShellPatternDiagram(ctx, centerX, centerY, currentRounds);
      } else if (currentPattern === 'cluster-pattern') {
        drawClusterPatternDiagram(ctx, centerX, centerY, currentRounds);
      } else if (currentPattern === 'popcorn-pattern') {
        drawPopcornPatternDiagram(ctx, centerX, centerY, currentRounds);
      }
    }

    function drawGrannySquareDiagram(ctx, centerX, centerY, rounds) {
      // Zentrum (Magic Ring)
      ctx.beginPath();
      ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
      ctx.fillStyle = '#374151';
      ctx.fill();
      
      // Runden zeichnen
      for (let round = 1; round <= rounds; round++) {
        const size = 25 + (round - 1) * 30;
        
        // Quadrat-Umriss
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 2;
        ctx.strokeRect(centerX - size, centerY - size, size * 2, size * 2);
        
        // Ecken (3er-St√§bchengruppen)
        const corners = [
          [centerX - size, centerY - size],
          [centerX + size, centerY - size],
          [centerX + size, centerY + size],
          [centerX - size, centerY + size]
        ];
        
        corners.forEach(([x, y]) => {
          for (let i = 0; i < 3; i++) {
            const offsetX = (i - 1) * 6;
            const offsetY = (i - 1) * 2;
            drawSymbol(ctx, 'dc', x + offsetX, y + offsetY, 0.6, '#374151');
          }
          
          drawSymbol(ctx, 'chain', x + 12, y + 12, 0.4, '#059669');
          drawSymbol(ctx, 'chain', x + 12, y + 18, 0.4, '#059669');
        });
        
        // Seitengruppen f√ºr Runden > 1
        if (round > 1) {
          const sideGroups = round - 1;
          for (let side = 0; side < 4; side++) {
            for (let s = 0; s < sideGroups; s++) {
              const sideOffset = (s - sideGroups/2 + 0.5) * 20;
              
              let x, y;
              if (side === 0) {
                x = centerX + sideOffset;
                y = centerY - size;
              } else if (side === 1) {
                x = centerX + size;
                y = centerY + sideOffset;
              } else if (side === 2) {
                x = centerX - sideOffset;
                y = centerY + size;
              } else {
                x = centerX - size;
                y = centerY - sideOffset;
              }
              
              for (let i = 0; i < 3; i++) {
                const offsetX = (i - 1) * 5;
                drawSymbol(ctx, 'dc', x + offsetX, y, 0.5, '#059669');
              }
            }
          }
        }
      }
    }

    function drawCircleDiagram(ctx, centerX, centerY, rounds, startStitches) {
      // Zentrum
      ctx.beginPath();
      ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
      ctx.fillStyle = '#374151';
      ctx.fill();
      
      // Runden
      for (let round = 1; round <= rounds; round++) {
        const radius = 25 + (round - 1) * 25;
        const stitches = startStitches * round;
        
        for (let i = 0; i < stitches; i++) {
          const angle = (2 * Math.PI * i) / stitches;
          const x = centerX + radius * Math.cos(angle);
          const y = centerY + radius * Math.sin(angle);
          
          const color = (round > 1 && i % round === 0) ? '#059669' : '#3b82f6';
          const symbol = (round > 1 && i % round === 0) ? 'inc2' : 'sc';
          
          drawSymbol(ctx, symbol, x, y, 0.6, color);
        }
      }
    }

    function drawShellPatternDiagram(ctx, centerX, centerY, rounds) {
      // Zentrum
      ctx.beginPath();
      ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
      ctx.fillStyle = '#374151';
      ctx.fill();
      
      for (let round = 1; round <= rounds; round++) {
        const radius = 30 + (round - 1) * 30;
        const shells = 6 * round;
        
        for (let i = 0; i < shells; i++) {
          const angle = (2 * Math.PI * i) / shells;
          const x = centerX + radius * Math.cos(angle);
          const y = centerY + radius * Math.sin(angle);
          
          drawSymbol(ctx, 'shell', x, y, 0.7, '#3b82f6');
        }
      }
    }

    function drawClusterPatternDiagram(ctx, centerX, centerY, rounds) {
      ctx.beginPath();
      ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
      ctx.fillStyle = '#374151';
      ctx.fill();
      
      for (let round = 1; round <= rounds; round++) {
        const radius = 30 + (round - 1) * 30;
        const clusters = 8 * round;
        
        for (let i = 0; i < clusters; i++) {
          const angle = (2 * Math.PI * i) / clusters;
          const x = centerX + radius * Math.cos(angle);
          const y = centerY + radius * Math.sin(angle);
          
          drawSymbol(ctx, 'cluster3', x, y, 0.7, '#3b82f6');
        }
      }
    }

    function drawPopcornPatternDiagram(ctx, centerX, centerY, rounds) {
      ctx.beginPath();
      ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
      ctx.fillStyle = '#374151';
      ctx.fill();
      
      for (let round = 1; round <= rounds; round++) {
        const radius = 30 + (round - 1) * 30;
        const popcorns = 6 * round;
        
        for (let i = 0; i < popcorns; i++) {
          const angle = (2 * Math.PI * i) / popcorns;
          const x = centerX + radius * Math.cos(angle);
          const y = centerY + radius * Math.sin(angle);
          
          drawSymbol(ctx, 'popcorn5', x, y, 0.7, '#3b82f6');
        }
      }
    }

    // Hauptfunktionen
    function switchPattern(pattern) {
      currentPattern = pattern;
      updateCalculation();
    }

    function updateCalculation() {
      const rounds = parseInt(document.getElementById('rounds').value);
      const startStitchesInput = parseInt(document.getElementById('startStitches').value);
      const stitchType = document.getElementById('stitchType').value;
      const yarnWeight = document.getElementById('yarnWeight').value;
      
      currentRounds = rounds;
      startStitches = startStitchesInput;
      
      const pattern = patterns[currentPattern];
      const calculation = calculateStitches(pattern, rounds, startStitches);
      
      updateResultDisplay(calculation);
      updateMaterials(yarnWeight, rounds, pattern);
      drawDiagram();
      generateInstructions(calculation);
    }

    function updateResultDisplay(calculation) {
      const lastRound = calculation[calculation.length - 1];
      const totalStitches = lastRound.stitches;
      const pattern = patterns[currentPattern];
      
      document.getElementById('resultText').textContent = 
        `${pattern.name} mit ${currentRounds} Runden: ${totalStitches} Maschen insgesamt`;
    }

    function updateMaterials(yarnWeight, rounds, pattern) {
      const yarnSpec = yarnWeights[yarnWeight];
      const baseYarn = rounds * rounds * yarnSpec.yarnFactor * 15;
      
      document.getElementById('yarnAmount').textContent = `ca. ${Math.round(baseYarn)} g (${yarnWeight.toUpperCase()})`;
      document.getElementById('hookSize').textContent = yarnSpec.hookSize;
      document.getElementById('finishedSize').textContent = `ca. ${Math.round(rounds * 4)} cm`;
      document.getElementById('workTime').textContent = `ca. ${Math.round(rounds * 0.75)} Stunden`;
    }

    function generateInstructions(calculation) {
      const container = document.getElementById('instructionsContainer');
      const pattern = patterns[currentPattern];
      
      container.innerHTML = `<h3>üß∂ ${pattern.name} - Anleitung</h3>`;
      
      calculation.forEach((round, index) => {
        const roundDiv = document.createElement('div');
        roundDiv.className = 'round-instruction';
        roundDiv.innerHTML = `
          <div class="round-number">Runde ${round.round}: <span class="stitch-count">(${round.stitches} Maschen)</span></div>
          <div class="round-text">${round.description}</div>
        `;
        container.appendChild(roundDiv);
      });
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Tab-Funktionalit√§t
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const pattern = this.dataset.pattern;
          switchPattern(pattern);
          
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
        });
      });
      
      // Input-Listener
      document.getElementById('rounds').addEventListener('input', updateCalculation);
      document.getElementById('startStitches').addEventListener('input', updateCalculation);
      document.getElementById('stitchType').addEventListener('change', updateCalculation);
      document.getElementById('yarnWeight').addEventListener('change', updateCalculation);
      
      // Initiale Berechnung
      updateCalculation();
      
      // Projekte laden wenn DB bereit ist
      document.addEventListener('dbReady', loadProjects);
      
      // Wenn DB bereits bereit ist
      if (window.crochetDB && window.crochetDB.isReady) {
        loadProjects();
      }
    });
    
    // PWA Management Funktionen
    function installPWA() {
      if (window.pwaManager && window.pwaManager.deferredPrompt) {
        window.pwaManager.deferredPrompt.prompt();
      }
    }
    
    function hideInstallBanner() {
      document.getElementById('installBanner').classList.remove('show');
      localStorage.setItem('installBannerHidden', 'true');
    }
    
    // Projekt speichern
    async function saveCurrentProject() {
      const projectName = document.getElementById('projectName').value;
      if (!projectName.trim()) {
        alert('Bitte einen Projekt-Namen eingeben!');
        return;
      }
      
      const projectData = {
        name: projectName.trim(),
        pattern: currentPattern,
        rounds: currentRounds,
        startStitches: startStitches,
        yarnWeight: document.getElementById('yarnWeight').value,
        stitchType: document.getElementById('stitchType').value,
        description: `${patterns[currentPattern].name} mit ${currentRounds} Runden`
      };
      
      try {
        await crochetDB.saveProject(projectData);
        document.getElementById('projectName').value = '';
        loadProjects();
        
        if (window.pwaManager) {
          window.pwaManager.showNotification('Projekt gespeichert! üíæ', 'success');
        }
      } catch (error) {
        console.error('Fehler beim Speichern:', error);
        alert('Fehler beim Speichern des Projekts!');
      }
    }
    
    // Projekte laden
    async function loadProjects() {
      try {
        const projects = await crochetDB.loadProjects();
        const projectsList = document.getElementById('projectsList');
        
        if (projects.length === 0) {
          projectsList.innerHTML = `
            <div class="empty-projects">
              <div class="empty-projects-icon">üìÅ</div>
              <p>Noch keine Projekte gespeichert</p>
            </div>
          `;
          return;
        }
        
        projectsList.innerHTML = projects.map(project => `
          <div class="project-item" onclick="loadProject(${project.id})">
            <div class="project-name">${project.name}</div>
            <div class="project-details">
              <span>${project.pattern} ‚Ä¢ ${project.rounds} Runden ‚Ä¢ ${project.yarnWeight}</span>
              <div class="project-actions">
                <button class="edit-btn" onclick="event.stopPropagation(); editProject(${project.id})" title="Bearbeiten">‚úèÔ∏è</button>
                <button class="share-btn" onclick="event.stopPropagation(); shareProject(${project.id})" title="Teilen">üì§</button>
                <button class="delete-btn" onclick="event.stopPropagation(); deleteProject(${project.id})" title="L√∂schen">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Fehler beim Laden der Projekte:', error);
      }
    }
    
    // Projekt laden
    async function loadProject(projectId) {
      try {
        const project = await crochetDB.loadProject(projectId);
        
        if (project) {
          // Projekt-Daten in UI laden
          document.getElementById('rounds').value = project.rounds;
          document.getElementById('startStitches').value = project.startStitches;
          document.getElementById('yarnWeight').value = project.yarnWeight;
          document.getElementById('stitchType').value = project.stitchType;
          
          // Muster wechseln
          switchPattern(project.pattern);
          
          // Tab aktivieren
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelector(`[data-pattern="${project.pattern}"]`).classList.add('active');
          
          if (window.pwaManager) {
            window.pwaManager.showNotification(`Projekt "${project.name}" geladen! üìÇ`, 'success');
          }
        }
      } catch (error) {
        console.error('Fehler beim Laden des Projekts:', error);
      }
    }
    
    // Projekt bearbeiten
    async function editProject(projectId) {
      const project = await crochetDB.loadProject(projectId);
      if (project) {
        const newName = prompt('Neuer Projekt-Name:', project.name);
        if (newName && newName.trim()) {
          project.name = newName.trim();
          await crochetDB.updateProject(project);
          loadProjects();
          
          if (window.pwaManager) {
            window.pwaManager.showNotification('Projekt aktualisiert! ‚úèÔ∏è', 'success');
          }
        }
      }
    }
    
    // Projekt teilen
    async function shareProject(projectId) {
      const project = await crochetDB.loadProject(projectId);
      if (project && window.pwaManager) {
        window.pwaManager.shareProject(project);
      }
    }
    
    // Projekt l√∂schen
    async function deleteProject(projectId) {
      if (confirm('Projekt wirklich l√∂schen?')) {
        try {
          await crochetDB.deleteProject(projectId);
          loadProjects();
          
          if (window.pwaManager) {
            window.pwaManager.showNotification('Projekt gel√∂scht! üóëÔ∏è', 'success');
          }
        } catch (error) {
          console.error('Fehler beim L√∂schen:', error);
          alert('Fehler beim L√∂schen des Projekts!');
        }
      }
    }
    
    // Install Banner anzeigen
    window.addEventListener('beforeinstallprompt', (event) => {
      event.preventDefault();
      const installBanner = document.getElementById('installBanner');
      const bannerHidden = localStorage.getItem('installBannerHidden');
      
      if (!bannerHidden) {
        installBanner.classList.add('show');
      }
    });
    
    // Keyboard Shortcuts
    document.addEventListener('keydown', (event) => {
      if (event.ctrlKey || event.metaKey) {
        switch(event.key) {
          case 's':
            event.preventDefault();
            saveCurrentProject();
            break;
          case 'n':
            event.preventDefault();
            document.getElementById('projectName').focus();
            break;
        }
      }
    });
  </script>
</body>
</html>
